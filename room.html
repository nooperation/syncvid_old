<!doctype html>
<html>

<head>
  <title>Watch With Me</title>
  <!-- Latest compiled and minified CSS -->
  <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <script src="/socket.io/socket.io.js"></script>
  <style>
    #player_container {
      position: absolute;
      overflow: hidden;
      left: 0;
      top: 0;
      right: 320px;
      bottom: 0px;
      z-index: 4;
      background: #000000;
    }
    
    #footer_container {
      position: absolute;
      height: 84px;
      right: 320px;
      overflow-x: scroll;
      bottom: 0;
      left: 0;
      background: #efeef1;
    }
    
    html,
    body {
      height: 100%;
    }
    
    body {
      margin: 0;
    }
    
    #chat_header {
      background: #ffffff;
      height: 40px;
      position: fixed;
      top: 0px;
      right: 0px;
      width: 320px;
      font-size: 18px;
    }

    #playlist_header {
      background: #ffffff;
      height: 40px;
      position: fixed;
      top: 40px;
      right: 0px;
      width: 320px;
      font-size: 18px;
      padding: 5px;
    }

    #playlist_content {
      position: absolute;
      top: 80px;
      right: 0px;
      width: 320px;
      height: 160px;
      overflow-y: scroll;
    }

    #chat_content {
      position: absolute;
      top: 240px;
      right: 0px;
      width: 320px;
      bottom: 45px;
      overflow-y: scroll;
    }
    
    #chat_messages_container {
      overflow: auto;
    }
    
    #chat_input_container {
      position: fixed;
      bottom: 0px;
      right: 0px;
      width: 320px;
      height: 45px;
      padding: 5px;
      margin: 0px;
    }
    
    #chat_input_container .spacer {
      padding: 5px;
    }
    
    body {
      font: 13px Helvetica, Arial;
      margin: 0;
    }
    
    #chat_messages {
      list-style-type: none;
      margin: 0;
      padding: 0;
    }

    #playlist_items {
      list-style-type: none;
      margin: 0;
      padding: 0;
    }
    
    li {
      overflow-wrap: break-word;
    }
    #chat_messages li {
      padding: 5px 10px;
    }
    
    #chat_messages li:nth-child(odd) {
      background: #e5e5e5;
    }

    .playlist_thubnail {
      width: 64px;
      height: 64px;
      position: absolute;
      left: 15px;
    }

    .playlist_item {
      left: 15px;
      right: 0px;
      height: 80px;
      margin: 10px;

      list-style-type: none;
    }

    .playlist_item.Playing {
      background-image: linear-gradient(to bottom,#a8c8a8 0,#c5f5c5 100%);
    }
    .playlist_item.Played {
      background-image: linear-gradient(to bottom,#a8a8a8 0,#c5c5c5 100%);
    }
    .playlist_item.Queued {
      background-image: linear-gradient(to bottom,#e8e8e8 0,#f5f5f5 100%);
    }

    .playlist_title {
      position: absolute;
      left: 84px;
      right: 35px;
    }

    .playlist_item_remove {
      float: right;
      color: #d02626;
    }


  </style>
</head>

<body>
  <div id="player_container">
    <div id="player"></div>
  </div>
  <div id="chat_container">
    <div id="chat_header" class="text-center well well-sm">
      Error
      <ul id="chat_userlist"></ul>
    </div>
    <div id="playlist_header">
      <div class="form-group">
        <form id="playlist_form" action="">
          <div class="input-group">
            <input id="playlist_input" class="form-control" type="text" autocomplete="off" placeholder="Paste URL or ID here..." />
            <span class="input-group-btn">
              <button class="btn btn-default" type="submit">Add</button>
            </span>
          </div>
        </form>
      </div>
    </div>
    <div id="playlist_content">
      Error
      <ul id="playlist_items" />
    </div>
    <div id="chat_content">
      <div id="chat_messages_container">
        <ul id="chat_messages"></ul>
      </div>
      <div id="chat_input_container" class="form-group">
        <form action="" id="chat_form">
          <div class="input-group">
            <input id="chat_input" class="form-control" type="text" autocomplete="off" placeholder="Write your message here..." />
            <span class="input-group-btn">
              <button class="btn btn-default" type="submit">Send</button>
            </span>
          </div>
        </form>
      </div>
    </div>
    <div id="footer_container">
    </div>

    <script>
      var socket = io();
      var player = null;
      
      // 2. This code loads the IFrame Player API code asynchronously.
      var player_tag = document.createElement('script');

      player_tag.src = "https://www.youtube.com/iframe_api";
      var firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(player_tag, firstScriptTag);

      // 3. This function creates an <iframe> (and YouTube player)
      //    after the API code downloads.
      function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
          height: '100%',
          width: '100%',
          videoId: null,
          playerVars: {
            autoplay: 0,
          },
          events: {
            'onStateChange': onPlayerStateChange
          }
        });
      }

      // 4. The API will call this function when the video player is ready.
      function onPlayerReady(event) {
        event.target.playVideo();
      }

      // 5. The API calls this function when the player's state changes.
      //    The function indicates that when playing a video (state=1),
      //    the player should play for six seconds and then stop.

      function onPlayerStateChange(event) {
        if(is_owner == false) {
          return;
        }

        if(player.getPlayerState() == YT.PlayerState.ENDED) {
          socket.emit('play_next_playlist_item');
        }

        updateServerState();
      }

      function updateServerState(){
        if(player == null) {
          return;
        }

        var video_data = player.getVideoData();
        var new_player_state = {
          'video_id': video_data.video_id,
          'player_state': player.getPlayerState(),
          'current_time': player.getCurrentTime(),
          'playback_rate': player.getPlaybackRate(),
        };

        socket.emit('player_state_change', new_player_state);
      };

      function changeVideo() {
        if(is_owner) {
          var new_id = input("New ID");
          player.loadVideoById(new_id, 0, "large");
        }
      }

      function removePlaylistItem(item){
        socket.emit('remove_playlist_item', item);
      }

      function selectPlaylistItem(item){
        socket.emit('select_playlist_item', item);
      }

      var room_name = window.location.pathname.substr(6);
      var user_name = "Guest";
      var is_owner = false;
      var update_timer = null;

      socket.emit('join', user_name, room_name);
      
      $('#chat_form').submit(function(){
        var chat_input = $('#chat_input');
        if(chat_input.val().trim().length > 0)
        {
          socket.emit('message', chat_input.val(), '#ff0000');
        }
        chat_input.val('');
        return false;
      });

      $('#playlist_form').submit(function(){
        var playlist_input = $('#playlist_input');
        var video_id = playlist_input.val().trim();
        if(video_id.length > 0)
        {
          socket.emit('queue_playlist_item', video_id);
        }
        playlist_input.val('');
        return false;
      });

      socket.on('message', function(message_type, message, username, user_color) {
        var element_username = $('<b>');
        element_username.text(username);
        element_username.css('color', user_color);

        var element_text = $('<span>');
        element_text.text(': ' + message);

        var element_message_container = $('<li>');
        element_message_container.append(element_username);
        element_message_container.append(element_text);

        $('#chat_messages').append(element_message_container);

        var chat_container = document.getElementById("chat_content");
        chat_container.scrollTop = chat_container.scrollHeight;
      });

      socket.on('init', function(){
      });

      socket.on('join_success', function(initial_state){
        $('#chat_header').text(initial_state.room_name);
      });

      socket.on('change_owner', function(is_new_owner){
        is_owner = is_new_owner;

        if(update_timer != null)
        {
          window.clearInterval(update_timer);
        }

        if(is_owner)
        {
          update_timer = window.setInterval(updateServerState, 1000);
        }
      });

      socket.on('player_state_change', function(new_state){
        if(player == null) {
          return;
        }

        var video_data = player.getVideoData();
        if(video_data.video_id != new_state.video_id)
        {
          player.loadVideoById(new_state.video_id, new_state.current_time, "default");
        }
        else
        {
          var time_diff_from_host = Math.abs(player.getCurrentTime() - new_state.current_time);
          if(time_diff_from_host > 1)
          {
            player.seekTo(new_state.current_time);
          }
            
          player.setPlaybackRate(new_state.playback_rate);
        }

        switch(new_state.player_state)
        {
          case YT.PlayerState.PLAYING:
            player.playVideo();
            break;
          case YT.PlayerState.PAUSED:
            player.pauseVideo();
            break;
          case YT.PlayerState.ENDED:
            break;
        }
      });

      socket.on('update_user_list', function(updated_userlist){
      });

      socket.on('play_playlist_item', function(playlist_item_data){
        if(player == null) {
          return;
        }

        player.loadVideoById(playlist_item_data.video_id, 0, "default");
      });

      socket.on('update_playlist', function(updated_playlist){
        $('#playlist_content').text('');

        if(updated_playlist.length == 0)
        {
          $('#playlist_content').append($('<li class="playlist_item panel panel-info">' +
            '<div class="panel-heading">Playlist is empty.</div>' +
            '<div class="panel-body">Start by submitting a video id above.</div>' +
            '</li>'
          ));
        }
        else
        {
          var currently_playing = null;

          for(var i = 0; i < updated_playlist.length; ++i)
          {
            var item = updated_playlist[i];
            if(item.state == 'Playing') {
              currently_playing = item.unique_id;
            }

            var truncated_title = (item.title.length > 95) ? (item.title.substr(0, 95) + '...') : item.title;

            var element_thumbnail_link_image = $('<img class="img-thumbnail playlist_thubnail">');
            element_thumbnail_link_image.attr('src', item.thumbnail_url);

            var element_thumbnail_link = $('<a>');
            element_thumbnail_link.attr('onclick', 'selectPlaylistItem(\'' + item.unique_id + '\');');
            element_thumbnail_link.append(element_thumbnail_link_image);

            var element_thumbnail_text = $('<a class="playlist_title">');
            element_thumbnail_text.attr('target', 'self');
            element_thumbnail_text.attr('href', item.url);
            element_thumbnail_text.text(truncated_title);

            var element_thumbnail_button = $('<a class="playlist_item_remove glyphicon glyphicon-remove">');
            element_thumbnail_button.attr('onclick', 'removePlaylistItem(\'' + item.unique_id + '\');');

            var element_playlist_item_container = $('<li>');
            element_playlist_item_container.attr('class', 'playlist_item well well-sm ' + item.state);
            element_playlist_item_container.attr('id', item.unique_id);
            element_playlist_item_container.append(element_thumbnail_link);
            element_playlist_item_container.append(element_thumbnail_text);
            element_playlist_item_container.append(element_thumbnail_button);

            $('#playlist_content').append(element_playlist_item_container);
          }
        }
      });
    </script>
</body>

</html>
